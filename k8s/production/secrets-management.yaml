<<<<<<< HEAD
# HashiCorp Vault Integration for Production Secrets Management
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: bharatvoice
data:
  vault-config.hcl: |
    ui = true
    
    listener "tcp" {
      address = "0.0.0.0:8200"
      tls_disable = false
      tls_cert_file = "/vault/tls/vault.crt"
      tls_key_file = "/vault/tls/vault.key"
    }
    
    storage "postgresql" {
      connection_url = "postgres://vault:vaultpassword@postgres-service:5432/vault?sslmode=require"
      table = "vault_kv_store"
      max_parallel = "128"
    }
    
    seal "awskms" {
      region = "us-east-1"
      kms_key_id = "arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012"
    }
    
    api_addr = "https://vault.bharatvoice.internal:8200"
    cluster_addr = "https://vault.bharatvoice.internal:8201"
    
    # Enable audit logging
    audit {
      file {
        file_path = "/vault/logs/audit.log"
        log_raw = false
        hmac_accessor = true
        mode = 0600
        format = "json"
      }
    }
    
    # Telemetry
    telemetry {
      prometheus_retention_time = "30s"
      disable_hostname = true
    }
  
  vault-init.sh: |
    #!/bin/bash
    set -e
    
    echo "Initializing Vault..."
    
    # Wait for Vault to be ready
    until vault status; do
      echo "Waiting for Vault to be ready..."
      sleep 5
    done
    
    # Initialize Vault if not already initialized
    if ! vault status | grep -q "Initialized.*true"; then
      echo "Initializing Vault..."
      vault operator init -key-shares=5 -key-threshold=3 -format=json > /vault/data/init-keys.json
      
      # Unseal Vault
      UNSEAL_KEY_1=$(cat /vault/data/init-keys.json | jq -r '.unseal_keys_b64[0]')
      UNSEAL_KEY_2=$(cat /vault/data/init-keys.json | jq -r '.unseal_keys_b64[1]')
      UNSEAL_KEY_3=$(cat /vault/data/init-keys.json | jq -r '.unseal_keys_b64[2]')
      
      vault operator unseal $UNSEAL_KEY_1
      vault operator unseal $UNSEAL_KEY_2
      vault operator unseal $UNSEAL_KEY_3
      
      # Get root token
      ROOT_TOKEN=$(cat /vault/data/init-keys.json | jq -r '.root_token')
      vault auth $ROOT_TOKEN
      
      # Enable KV secrets engine
      vault secrets enable -version=2 kv
      
      # Enable Kubernetes auth
      vault auth enable kubernetes
      
      # Configure Kubernetes auth
      vault write auth/kubernetes/config \
        token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
        kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
        kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      
      # Create policy for BharatVoice application
      vault policy write bharatvoice-policy - <<EOF
    path "kv/data/bharatvoice/*" {
      capabilities = ["read"]
    }
    
    path "kv/data/external-apis/*" {
      capabilities = ["read"]
    }
    
    path "kv/data/database/*" {
      capabilities = ["read"]
    }
    
    path "auth/token/lookup-self" {
      capabilities = ["read"]
    }
    
    path "auth/token/renew-self" {
      capabilities = ["update"]
    }
    
    path "auth/token/revoke-self" {
      capabilities = ["update"]
    }
    EOF
      
      # Create Kubernetes role
      vault write auth/kubernetes/role/bharatvoice \
        bound_service_account_names=bharatvoice-app-sa \
        bound_service_account_namespaces=bharatvoice \
        policies=bharatvoice-policy \
        ttl=24h
      
      echo "Vault initialization completed"
    else
      echo "Vault is already initialized"
    fi
  
  vault-secrets.sh: |
    #!/bin/bash
    set -e
    
    echo "Storing secrets in Vault..."
    
    # Authenticate with Vault
    vault auth -method=kubernetes role=bharatvoice
    
    # Store application secrets
    vault kv put kv/bharatvoice/app \
      secret_key="${SECRET_KEY}" \
      encryption_key="${ENCRYPTION_KEY}" \
      jwt_secret="${JWT_SECRET}"
    
    # Store database secrets
    vault kv put kv/bharatvoice/database \
      postgres_user="${POSTGRES_USER}" \
      postgres_password="${POSTGRES_PASSWORD}" \
      postgres_db="${POSTGRES_DB}"
    
    # Store Redis secrets
    vault kv put kv/bharatvoice/redis \
      redis_password="${REDIS_PASSWORD}"
    
    # Store external API secrets
    vault kv put kv/external-apis/railways \
      api_key="${INDIAN_RAILWAYS_API_KEY}"
    
    vault kv put kv/external-apis/weather \
      openweathermap_key="${OPENWEATHERMAP_API_KEY}" \
      imd_key="${IMD_API_KEY}"
    
    vault kv put kv/external-apis/payment \
      razorpay_key_id="${RAZORPAY_KEY_ID}" \
      razorpay_key_secret="${RAZORPAY_KEY_SECRET}" \
      payu_merchant_key="${PAYU_MERCHANT_KEY}" \
      payu_merchant_salt="${PAYU_MERCHANT_SALT}"
    
    vault kv put kv/external-apis/platforms \
      swiggy_api_key="${SWIGGY_API_KEY}" \
      ola_client_id="${OLA_CLIENT_ID}" \
      ola_client_secret="${OLA_CLIENT_SECRET}"
    
    echo "Secrets stored in Vault successfully"
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
  namespace: bharatvoice
  labels:
    app: vault
spec:
  serviceName: vault
  replicas: 3
  selector:
    matchLabels:
      app: vault
  template:
    metadata:
      labels:
        app: vault
    spec:
      serviceAccountName: vault-sa
      containers:
      - name: vault
        image: vault:1.15.0
        ports:
        - containerPort: 8200
          name: vault-port
        - containerPort: 8201
          name: cluster-port
        env:
        - name: VAULT_ADDR
          value: "https://127.0.0.1:8200"
        - name: VAULT_API_ADDR
          value: "https://vault.bharatvoice.internal:8200"
        - name: VAULT_CLUSTER_ADDR
          value: "https://$(POD_IP):8201"
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: VAULT_LOG_LEVEL
          value: "info"
        - name: VAULT_DISABLE_MLOCK
          value: "true"
        command:
        - /bin/sh
        - -c
        - |
          vault server -config=/vault/config/vault-config.hcl
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
        - name: vault-data
          mountPath: /vault/data
        - name: vault-logs
          mountPath: /vault/logs
        - name: vault-tls
          mountPath: /vault/tls
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /v1/sys/health?standbyok=true
            port: 8200
            scheme: HTTPS
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204
            port: 8200
            scheme: HTTPS
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 100
          runAsGroup: 1000
          capabilities:
            drop:
            - ALL
            add:
            - IPC_LOCK
      volumes:
      - name: vault-config
        configMap:
          name: vault-config
      - name: vault-tls
        secret:
          secretName: vault-tls-certs
  volumeClaimTemplates:
  - metadata:
      name: vault-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 10Gi
  - metadata:
      name: vault-logs
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: standard
      resources:
        requests:
          storage: 5Gi
---
apiVersion: v1
kind: Service
metadata:
  name: vault
  namespace: bharatvoice
  labels:
    app: vault
spec:
  selector:
    app: vault
  ports:
  - port: 8200
    targetPort: 8200
    name: vault-port
  - port: 8201
    targetPort: 8201
    name: cluster-port
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: vault-headless
  namespace: bharatvoice
  labels:
    app: vault
spec:
  selector:
    app: vault
  ports:
  - port: 8200
    targetPort: 8200
    name: vault-port
  - port: 8201
    targetPort: 8201
    name: cluster-port
  clusterIP: None
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-sa
  namespace: bharatvoice
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vault-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["serviceaccounts/token"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vault-role
subjects:
- kind: ServiceAccount
  name: vault-sa
  namespace: bharatvoice
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-agent-config
  namespace: bharatvoice
data:
  vault-agent.hcl: |
    pid_file = "/tmp/pidfile"
    
    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = "bharatvoice"
        }
      }
      
      sink "file" {
        config = {
          path = "/vault/secrets/token"
        }
      }
    }
    
    template {
      source = "/vault/templates/app-secrets.tpl"
      destination = "/vault/secrets/app-secrets.env"
      perms = 0600
    }
    
    template {
      source = "/vault/templates/db-secrets.tpl"
      destination = "/vault/secrets/db-secrets.env"
      perms = 0600
    }
    
    template {
      source = "/vault/templates/api-secrets.tpl"
      destination = "/vault/secrets/api-secrets.env"
      perms = 0600
    }
    
    vault {
      address = "https://vault:8200"
      tls_skip_verify = false
      ca_cert = "/vault/tls/ca.crt"
    }
  
  app-secrets.tpl: |
    {{- with secret "kv/data/bharatvoice/app" -}}
    SECRET_KEY="{{ .Data.data.secret_key }}"
    ENCRYPTION_KEY="{{ .Data.data.encryption_key }}"
    JWT_SECRET="{{ .Data.data.jwt_secret }}"
    {{- end }}
  
  db-secrets.tpl: |
    {{- with secret "kv/data/bharatvoice/database" -}}
    POSTGRES_USER="{{ .Data.data.postgres_user }}"
    POSTGRES_PASSWORD="{{ .Data.data.postgres_password }}"
    POSTGRES_DB="{{ .Data.data.postgres_db }}"
    {{- end }}
    
    {{- with secret "kv/data/bharatvoice/redis" -}}
    REDIS_PASSWORD="{{ .Data.data.redis_password }}"
    {{- end }}
  
  api-secrets.tpl: |
    {{- with secret "kv/data/external-apis/railways" -}}
    INDIAN_RAILWAYS_API_KEY="{{ .Data.data.api_key }}"
    {{- end }}
    
    {{- with secret "kv/data/external-apis/weather" -}}
    OPENWEATHERMAP_API_KEY="{{ .Data.data.openweathermap_key }}"
    IMD_API_KEY="{{ .Data.data.imd_key }}"
    {{- end }}
    
    {{- with secret "kv/data/external-apis/payment" -}}
    RAZORPAY_KEY_ID="{{ .Data.data.razorpay_key_id }}"
    RAZORPAY_KEY_SECRET="{{ .Data.data.razorpay_key_secret }}"
    PAYU_MERCHANT_KEY="{{ .Data.data.payu_merchant_key }}"
    PAYU_MERCHANT_SALT="{{ .Data.data.payu_merchant_salt }}"
    {{- end }}
    
    {{- with secret "kv/data/external-apis/platforms" -}}
    SWIGGY_API_KEY="{{ .Data.data.swiggy_api_key }}"
    OLA_CLIENT_ID="{{ .Data.data.ola_client_id }}"
    OLA_CLIENT_SECRET="{{ .Data.data.ola_client_secret }}"
    {{- end }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: bharatvoice
spec:
  template:
    spec:
      serviceAccountName: vault-sa
      containers:
      - name: vault-init
        image: vault:1.15.0
        command:
        - /bin/sh
        - /vault/config/vault-init.sh
        env:
        - name: VAULT_ADDR
          value: "https://vault:8200"
        - name: VAULT_SKIP_VERIFY
          value: "true"
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
        - name: vault-data
          mountPath: /vault/data
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: vault-config
        configMap:
          name: vault-config
          defaultMode: 0755
      - name: vault-data
        emptyDir: {}
      restartPolicy: OnFailure
=======
# HashiCorp Vault Integration for Production Secrets Management
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-config
  namespace: bharatvoice
data:
  vault-config.hcl: |
    ui = true
    
    listener "tcp" {
      address = "0.0.0.0:8200"
      tls_disable = false
      tls_cert_file = "/vault/tls/vault.crt"
      tls_key_file = "/vault/tls/vault.key"
    }
    
    storage "postgresql" {
      connection_url = "postgres://vault:vaultpassword@postgres-service:5432/vault?sslmode=require"
      table = "vault_kv_store"
      max_parallel = "128"
    }
    
    seal "awskms" {
      region = "us-east-1"
      kms_key_id = "arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012"
    }
    
    api_addr = "https://vault.bharatvoice.internal:8200"
    cluster_addr = "https://vault.bharatvoice.internal:8201"
    
    # Enable audit logging
    audit {
      file {
        file_path = "/vault/logs/audit.log"
        log_raw = false
        hmac_accessor = true
        mode = 0600
        format = "json"
      }
    }
    
    # Telemetry
    telemetry {
      prometheus_retention_time = "30s"
      disable_hostname = true
    }
  
  vault-init.sh: |
    #!/bin/bash
    set -e
    
    echo "Initializing Vault..."
    
    # Wait for Vault to be ready
    until vault status; do
      echo "Waiting for Vault to be ready..."
      sleep 5
    done
    
    # Initialize Vault if not already initialized
    if ! vault status | grep -q "Initialized.*true"; then
      echo "Initializing Vault..."
      vault operator init -key-shares=5 -key-threshold=3 -format=json > /vault/data/init-keys.json
      
      # Unseal Vault
      UNSEAL_KEY_1=$(cat /vault/data/init-keys.json | jq -r '.unseal_keys_b64[0]')
      UNSEAL_KEY_2=$(cat /vault/data/init-keys.json | jq -r '.unseal_keys_b64[1]')
      UNSEAL_KEY_3=$(cat /vault/data/init-keys.json | jq -r '.unseal_keys_b64[2]')
      
      vault operator unseal $UNSEAL_KEY_1
      vault operator unseal $UNSEAL_KEY_2
      vault operator unseal $UNSEAL_KEY_3
      
      # Get root token
      ROOT_TOKEN=$(cat /vault/data/init-keys.json | jq -r '.root_token')
      vault auth $ROOT_TOKEN
      
      # Enable KV secrets engine
      vault secrets enable -version=2 kv
      
      # Enable Kubernetes auth
      vault auth enable kubernetes
      
      # Configure Kubernetes auth
      vault write auth/kubernetes/config \
        token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
        kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443" \
        kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      
      # Create policy for BharatVoice application
      vault policy write bharatvoice-policy - <<EOF
    path "kv/data/bharatvoice/*" {
      capabilities = ["read"]
    }
    
    path "kv/data/external-apis/*" {
      capabilities = ["read"]
    }
    
    path "kv/data/database/*" {
      capabilities = ["read"]
    }
    
    path "auth/token/lookup-self" {
      capabilities = ["read"]
    }
    
    path "auth/token/renew-self" {
      capabilities = ["update"]
    }
    
    path "auth/token/revoke-self" {
      capabilities = ["update"]
    }
    EOF
      
      # Create Kubernetes role
      vault write auth/kubernetes/role/bharatvoice \
        bound_service_account_names=bharatvoice-app-sa \
        bound_service_account_namespaces=bharatvoice \
        policies=bharatvoice-policy \
        ttl=24h
      
      echo "Vault initialization completed"
    else
      echo "Vault is already initialized"
    fi
  
  vault-secrets.sh: |
    #!/bin/bash
    set -e
    
    echo "Storing secrets in Vault..."
    
    # Authenticate with Vault
    vault auth -method=kubernetes role=bharatvoice
    
    # Store application secrets
    vault kv put kv/bharatvoice/app \
      secret_key="${SECRET_KEY}" \
      encryption_key="${ENCRYPTION_KEY}" \
      jwt_secret="${JWT_SECRET}"
    
    # Store database secrets
    vault kv put kv/bharatvoice/database \
      postgres_user="${POSTGRES_USER}" \
      postgres_password="${POSTGRES_PASSWORD}" \
      postgres_db="${POSTGRES_DB}"
    
    # Store Redis secrets
    vault kv put kv/bharatvoice/redis \
      redis_password="${REDIS_PASSWORD}"
    
    # Store external API secrets
    vault kv put kv/external-apis/railways \
      api_key="${INDIAN_RAILWAYS_API_KEY}"
    
    vault kv put kv/external-apis/weather \
      openweathermap_key="${OPENWEATHERMAP_API_KEY}" \
      imd_key="${IMD_API_KEY}"
    
    vault kv put kv/external-apis/payment \
      razorpay_key_id="${RAZORPAY_KEY_ID}" \
      razorpay_key_secret="${RAZORPAY_KEY_SECRET}" \
      payu_merchant_key="${PAYU_MERCHANT_KEY}" \
      payu_merchant_salt="${PAYU_MERCHANT_SALT}"
    
    vault kv put kv/external-apis/platforms \
      swiggy_api_key="${SWIGGY_API_KEY}" \
      ola_client_id="${OLA_CLIENT_ID}" \
      ola_client_secret="${OLA_CLIENT_SECRET}"
    
    echo "Secrets stored in Vault successfully"
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: vault
  namespace: bharatvoice
  labels:
    app: vault
spec:
  serviceName: vault
  replicas: 3
  selector:
    matchLabels:
      app: vault
  template:
    metadata:
      labels:
        app: vault
    spec:
      serviceAccountName: vault-sa
      containers:
      - name: vault
        image: vault:1.15.0
        ports:
        - containerPort: 8200
          name: vault-port
        - containerPort: 8201
          name: cluster-port
        env:
        - name: VAULT_ADDR
          value: "https://127.0.0.1:8200"
        - name: VAULT_API_ADDR
          value: "https://vault.bharatvoice.internal:8200"
        - name: VAULT_CLUSTER_ADDR
          value: "https://$(POD_IP):8201"
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: VAULT_LOG_LEVEL
          value: "info"
        - name: VAULT_DISABLE_MLOCK
          value: "true"
        command:
        - /bin/sh
        - -c
        - |
          vault server -config=/vault/config/vault-config.hcl
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
        - name: vault-data
          mountPath: /vault/data
        - name: vault-logs
          mountPath: /vault/logs
        - name: vault-tls
          mountPath: /vault/tls
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /v1/sys/health?standbyok=true
            port: 8200
            scheme: HTTPS
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204
            port: 8200
            scheme: HTTPS
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 100
          runAsGroup: 1000
          capabilities:
            drop:
            - ALL
            add:
            - IPC_LOCK
      volumes:
      - name: vault-config
        configMap:
          name: vault-config
      - name: vault-tls
        secret:
          secretName: vault-tls-certs
  volumeClaimTemplates:
  - metadata:
      name: vault-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: fast-ssd
      resources:
        requests:
          storage: 10Gi
  - metadata:
      name: vault-logs
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: standard
      resources:
        requests:
          storage: 5Gi
---
apiVersion: v1
kind: Service
metadata:
  name: vault
  namespace: bharatvoice
  labels:
    app: vault
spec:
  selector:
    app: vault
  ports:
  - port: 8200
    targetPort: 8200
    name: vault-port
  - port: 8201
    targetPort: 8201
    name: cluster-port
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: vault-headless
  namespace: bharatvoice
  labels:
    app: vault
spec:
  selector:
    app: vault
  ports:
  - port: 8200
    targetPort: 8200
    name: vault-port
  - port: 8201
    targetPort: 8201
    name: cluster-port
  clusterIP: None
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-sa
  namespace: bharatvoice
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: vault-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["serviceaccounts/token"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: vault-role
subjects:
- kind: ServiceAccount
  name: vault-sa
  namespace: bharatvoice
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-agent-config
  namespace: bharatvoice
data:
  vault-agent.hcl: |
    pid_file = "/tmp/pidfile"
    
    auto_auth {
      method "kubernetes" {
        mount_path = "auth/kubernetes"
        config = {
          role = "bharatvoice"
        }
      }
      
      sink "file" {
        config = {
          path = "/vault/secrets/token"
        }
      }
    }
    
    template {
      source = "/vault/templates/app-secrets.tpl"
      destination = "/vault/secrets/app-secrets.env"
      perms = 0600
    }
    
    template {
      source = "/vault/templates/db-secrets.tpl"
      destination = "/vault/secrets/db-secrets.env"
      perms = 0600
    }
    
    template {
      source = "/vault/templates/api-secrets.tpl"
      destination = "/vault/secrets/api-secrets.env"
      perms = 0600
    }
    
    vault {
      address = "https://vault:8200"
      tls_skip_verify = false
      ca_cert = "/vault/tls/ca.crt"
    }
  
  app-secrets.tpl: |
    {{- with secret "kv/data/bharatvoice/app" -}}
    SECRET_KEY="{{ .Data.data.secret_key }}"
    ENCRYPTION_KEY="{{ .Data.data.encryption_key }}"
    JWT_SECRET="{{ .Data.data.jwt_secret }}"
    {{- end }}
  
  db-secrets.tpl: |
    {{- with secret "kv/data/bharatvoice/database" -}}
    POSTGRES_USER="{{ .Data.data.postgres_user }}"
    POSTGRES_PASSWORD="{{ .Data.data.postgres_password }}"
    POSTGRES_DB="{{ .Data.data.postgres_db }}"
    {{- end }}
    
    {{- with secret "kv/data/bharatvoice/redis" -}}
    REDIS_PASSWORD="{{ .Data.data.redis_password }}"
    {{- end }}
  
  api-secrets.tpl: |
    {{- with secret "kv/data/external-apis/railways" -}}
    INDIAN_RAILWAYS_API_KEY="{{ .Data.data.api_key }}"
    {{- end }}
    
    {{- with secret "kv/data/external-apis/weather" -}}
    OPENWEATHERMAP_API_KEY="{{ .Data.data.openweathermap_key }}"
    IMD_API_KEY="{{ .Data.data.imd_key }}"
    {{- end }}
    
    {{- with secret "kv/data/external-apis/payment" -}}
    RAZORPAY_KEY_ID="{{ .Data.data.razorpay_key_id }}"
    RAZORPAY_KEY_SECRET="{{ .Data.data.razorpay_key_secret }}"
    PAYU_MERCHANT_KEY="{{ .Data.data.payu_merchant_key }}"
    PAYU_MERCHANT_SALT="{{ .Data.data.payu_merchant_salt }}"
    {{- end }}
    
    {{- with secret "kv/data/external-apis/platforms" -}}
    SWIGGY_API_KEY="{{ .Data.data.swiggy_api_key }}"
    OLA_CLIENT_ID="{{ .Data.data.ola_client_id }}"
    OLA_CLIENT_SECRET="{{ .Data.data.ola_client_secret }}"
    {{- end }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: bharatvoice
spec:
  template:
    spec:
      serviceAccountName: vault-sa
      containers:
      - name: vault-init
        image: vault:1.15.0
        command:
        - /bin/sh
        - /vault/config/vault-init.sh
        env:
        - name: VAULT_ADDR
          value: "https://vault:8200"
        - name: VAULT_SKIP_VERIFY
          value: "true"
        volumeMounts:
        - name: vault-config
          mountPath: /vault/config
        - name: vault-data
          mountPath: /vault/data
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: vault-config
        configMap:
          name: vault-config
          defaultMode: 0755
      - name: vault-data
        emptyDir: {}
      restartPolicy: OnFailure
>>>>>>> 0eb0e95caee35c9eb86ecf88b155e812550321aa
  backoffLimit: 3